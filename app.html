<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>yt-jukebox</title>
  <script src="http://code.jquery.com/jquery-3.2.1.min.js"
    integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4="
    crossorigin="anonymous"></script>
  <script src="https://www.gstatic.com/firebasejs/4.2.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/4.2.0/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/4.2.0/firebase-database.js"></script>
  <script src="https://cdn.firebase.com/libs/firebaseui/2.3.0/firebaseui.js"></script>
  <link type="text/css" rel="stylesheet" href="https://cdn.firebase.com/libs/firebaseui/2.3.0/firebaseui.css" />
  <script src="http://kendo.cdn.telerik.com/2017.2.621/js/kendo.all.min.js"></script>
  <link type="text/css" rel="stylesheet" href="http://kendo.cdn.telerik.com/2017.2.621/styles/kendo.common.min.css"/>

  <script src="firebase/firebase-init.js"></script>
  <script src="firebase/kendo.firebase.js"></script>
  <style type="text/css">
    #song-request div { padding-bottom: 5px; }
    #song-request label { display: inline-block; width: 150px; break-after: right }
    #song-request input { width: 250px; }
  </style>

  <script type="text/javascript">

    function toggleUserStuff(loggedIn) {
      $(".logged-out").toggle(!loggedIn);
      return $(".logged-in").toggle(loggedIn);
    }

    function logout(){
      firebase.auth().signOut().then(function(){
        toggleUserStuff(false);
      },
      function (){
        // error case. not sure what to do, so...
        alert('logout failed. maybe try refreshing the page?');
      })
    }

    // validate the song request form and submit to firebase
    function request_song(){
      function fail(reason){ alert(reason); return false; }

      let vid = "",
          form = document.forms["song-request"];
      const fields = ["singer", "link", "title", "artist"];

      for (let i=0; i<fields.length; i++) {
        if (!form[fields[i]].value) return fail('missing required field: '+fields[i]);
      }

      try { vid = new URL(form['link'].value).searchParams.get('v'); }
      catch(e){ return fail('please use a youtube video link with v=XXXX in the query string.'); }

      if (vid.length!==11) return fail("video link contains an invalid video id.");

      $(form).find("button").prop("disabled", true);

      let request = {
        singer: form['singer'].value,
        title: form['title'].value,
        artist: form['artist'].value,
        vid: vid};

      let qRef = '/q'; // where to put the queue
      let key = firebase.database().ref(qRef).push().key,
          ups = {};
      ups[qRef+'/'+key] = request;
      firebase.database().ref().update(ups).then(function(){
        form.reset();
        $(form).find("button").prop("disabled", false);
      });
      return false;
    }

    function ensure_user() {
      let df = $.Deferred();
      firebase.auth().onAuthStateChanged(function (user) {
        if (user) {
          toggleUserStuff(true).find(".username").text(user.displayName);
          df.resolve(user);
        } else {
          toggleUserStuff(false);
          let ui = new firebaseui.auth.AuthUI(firebase.auth());
          ui.start('#firebaseui-auth-container', {
            signInSuccessUrl: 'app.html',
            signInOptions: [
              firebase.auth.GoogleAuthProvider.PROVIDER_ID,
              firebase.auth.EmailAuthProvider.PROVIDER_ID
            ],
            tosUrl: 'TODO'
          });
        }
      });
      return df.promise();
    }

    function ytk_songlist(user) {
      let grid = $('#ytk-songs').find('.grid').kendoGrid({
        columns: [
          {field:'v', title:'vid'},
          {field:'t', title:'title'},
          {field:'a', title:'artist'}],
        dataSource: {
          autoSync: true,
          schema: { model:{ id:'v'}},
          type:'firebase',
          transport:{
            firebase:{ ref:'/u/' + user.uid }}},
        editable: true,
        toolbar: ['create', 'save', 'cancel']
      }).data('kendoGrid');

      // make the grid rows sortable
      grid.table.kendoSortable({
        filter: '>tbody >tr',
        cursor: 'move',
        hint: function(elem){
          return $('<table class="k-grid k-widget"></table>')
            .append(elem.clone())
            .css({width: '640px', opacity: 0.7});
        },
        placeholder: function(elem) {
          let result = $('<tr class="placeholder"><td colspan="4"></td></tr>');
          result.find('td').css({"border-bottom": 'dashed silver 2px'});
          return result;
        },
        change: function(e){
          let skip = 0, // grid.dataSource.skip(),
              item = grid.dataSource.getByUid(e.item.data('uid'));
          grid.dataSource.remove(item);
          grid.dataSource.insert(e.newIndex + skip, item);
        }
      });
    }

    $(() => ensure_user().then(ytk_songlist));

  </script>
</head>
<body>
  <div id="firebaseui-auth-container"></div>
  <div class="logged-out">not logged in</div>
  <div class="logged-in">
    logged in as <span class="username">(user)</span>.
    <a href="#" onclick="logout();">log out</a>
  </div>
  <section id="ytk-request">
    <h1>Request a Song</h1>
    <form id="song-request" onsubmit="return request_song();">
      <div>
        <label for="singer">Who's singing?</label>
        <input id="singer"/>
      </div>
      <div>
        <label for="link">Youtube Video Link</label>
        <input id="link"/>
      </div>
      <div>
        <label for="title">Song Title:</label>
        <input id="title"/>
      </div>
      <div>
        <label for="artist">Song Artist:</label>
        <input id="artist"/>
      </div>
      <div>
        <label><!-- just for padding --></label>
        <button>request</button>
      </div>
    </form>
  </section>
  <section id="ytk-songs" class="logged-in">
    <h1>song list</h1>
    <div class="grid"></div>
  </section>
</body>
</html>
